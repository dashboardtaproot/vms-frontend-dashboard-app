<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VMS Dashboard</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and Babel for JSX transpilation -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- Custom Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }
        /* Style for disabled buttons */
        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        [contenteditable="true"].modified-cell {
            background-color: #fef9c3; /* yellow-100 */
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
        .table-layout {
            table-layout: fixed;
            width: 100%;
        }
        .table-layout th, .table-layout td {
            overflow-wrap: break-word;
        }
        .column-list-item.dragging {
            opacity: 0.5;
            background: #e0e7ff;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ===================================================================================
        // VMS Dashboard - React Application
        // ===================================================================================

        const { useState, useEffect, createContext, useContext, useReducer, useMemo, useCallback, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- Configuration & Utilities -----------------------------------------------------
        const API_BASE_URL = '/api';
        const DASHBOARD_CONFIGS = {
            'ecaltVMSDisplay': { title: 'Eclat VMS', companyName: 'Eclat Solutions LLC', postingFrom: 'All' },
            'taprootVMSDisplay': { title: 'Taproot VMS', companyName: 'Taproot Solutions INC', postingFrom: 'All' },
            'michiganDisplay': { title: 'Michigan VMS', companyName: 'Taproot Solutions INC', postingFrom: 'State Of Michigan' },
            'EclatTexasDisplay': { title: 'Eclat Texas VMS', companyName: 'Eclat Solutions LLC', postingFrom: 'State Of Texas' },
            'TaprootTexasDisplay': { title: 'Taproot Texas VMS', companyName: 'Taproot Solutions INC', postingFrom: 'State Of Texas' },
        };
        const EDITABLE_COLUMNS = ['Working By', 'No. of Resumes Submitted', 'Remarks', '1st Candidate Name', '2nd Candidate Name', '3rd Candidate Name'];
        const DATE_COLUMNS = ['Posting Date', 'Last Submission Date'];

        const formatDate = (isoString) => {
            if (!isoString || isoString === 'Need To Update') return isoString;
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return isoString;
                return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
            } catch (e) {
                return isoString;
            }
        };

        // --- API Helper --------------------------------------------------------------------
        const api = {
            call: async (endpoint, method = 'GET', body = null, params = {}) => {
                const url = new URL(`${API_BASE_URL}/${endpoint}`, window.location.origin);
                if (method === 'GET') Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (body) options.body = JSON.stringify(body);
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'An unknown error occurred.' }));
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`API call to ${endpoint} failed:`, error);
                    throw error;
                }
            },
            authenticateUser: (username, password) => api.call('authenticateUser', 'POST', { username, password }),
            getUsers: (authenticatedUsername) => api.call('getUsers', 'GET', null, { authenticatedUsername }),
            addUser: (userData, authenticatedUsername) => api.call('addUser', 'POST', { ...userData, authenticatedUsername }),
            updateUser: (originalUsername, userData, authenticatedUsername) => api.call('updateUser', 'POST', { originalUsername, userData, authenticatedUsername }),
            deleteUser: (usernameToDelete, authenticatedUsername) => api.call('deleteUser', 'POST', { usernameToDelete, authenticatedUsername }),
            getDashboardData: (sheetKey, authenticatedUsername) => api.call('getDashboardData', 'GET', null, { sheetKey, authenticatedUsername }),
            updateJobPosting: (updates, authenticatedUsername) => api.call('updateJobPosting', 'POST', { updates, authenticatedUsername }),
            updateJobStatus: (postingIds, newStatus, authenticatedUsername) => api.call('updateJobStatus', 'POST', { postingIds, newStatus, authenticatedUsername }),
            archiveOrDeleteJob: (postingIds, actionType, authenticatedUsername) => api.call('archiveOrDeleteJob', 'POST', { postingIds, actionType, authenticatedUsername }),
            saveUserDashboardPreferences: (authenticatedUsername, preferences) => api.call('saveUserDashboardPreferences', 'POST', { authenticatedUsername, preferences }),
        };

        // --- Authentication Context --------------------------------------------------------
        const AuthContext = createContext();
        const authReducer = (state, action) => {
            switch (action.type) {
                case 'LOGIN': return { ...state, isAuthenticated: true, user: action.payload, isFirstLogin: action.payload.isFirstLogin };
                case 'LOGOUT': return { ...state, isAuthenticated: false, user: null, isFirstLogin: false };
                case 'PASSWORD_CHANGED': return { ...state, isFirstLogin: false };
                case 'PREFERENCES_UPDATED': 
                    const newUser = { ...state.user, dashboardPreferences: action.payload };
                    localStorage.setItem('vms_user', JSON.stringify(newUser));
                    return { ...state, user: newUser };
                default: return state;
            }
        };
        const AuthProvider = ({ children }) => {
            const [state, dispatch] = useReducer(authReducer, { isAuthenticated: false, user: null, isFirstLogin: false });
            useEffect(() => {
                try {
                    const savedUser = localStorage.getItem('vms_user');
                    if (savedUser) dispatch({ type: 'LOGIN', payload: JSON.parse(savedUser) });
                } catch (error) { localStorage.removeItem('vms_user'); }
            }, []);
            const login = (userData) => { localStorage.setItem('vms_user', JSON.stringify(userData)); dispatch({ type: 'LOGIN', payload: userData }); };
            const logout = () => { localStorage.removeItem('vms_user'); dispatch({ type: 'LOGOUT' }); };
            const passwordChanged = () => {
                const updatedUser = { ...state.user, isFirstLogin: false };
                localStorage.setItem('vms_user', JSON.stringify(updatedUser));
                dispatch({ type: 'PASSWORD_CHANGED' });
            };
            const updatePreferences = (preferences) => {
                dispatch({ type: 'PREFERENCES_UPDATED', payload: preferences });
            };
            return <AuthContext.Provider value={{ ...state, login, logout, passwordChanged, updatePreferences }}>{children}</AuthContext.Provider>;
        };
        const useAuth = () => useContext(AuthContext);

        // --- Reusable UI Components --------------------------------------------------------
        const Modal = ({ isOpen, onClose, title, children, size = 'md' }) => {
            if (!isOpen) return null;
            const sizeClasses = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-lg', xl: 'max-w-xl' };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onClick={onClose}>
                    <div className={`bg-white rounded-lg shadow-xl w-full ${sizeClasses[size]} max-h-[90vh] flex flex-col`} onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-4 border-b">
                            <h3 className="text-xl font-semibold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                        <div className="p-6 overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };
        const Spinner = ({ size = '8' }) => <div className={`animate-spin rounded-full h-${size} w-${size} border-b-2 border-indigo-600`}></div>;

        const Dropdown = ({ trigger, children }) => {
            const [isOpen, setIsOpen] = useState(false);
            const node = useRef();
            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (node.current && !node.current.contains(e.target)) setIsOpen(false);
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);
            return (
                <div className="relative" ref={node}>
                    <div onClick={() => setIsOpen(!isOpen)}>{trigger}</div>
                    {isOpen && (
                        <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 py-1" onClick={() => setIsOpen(false)}>
                            {children}
                        </div>
                    )}
                </div>
            );
        };
        
        // --- Main Application Pages --------------------------------------------------------
        // ... (LoginPage, ChangePasswordPage, ReportsPage, AdminPage and their modals are assumed to be here and unchanged) ...
        const LoginPage = () => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const { login } = useAuth();
            const [isForgotPasswordOpen, setForgotPasswordOpen] = useState(false);
            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    const data = await api.authenticateUser(username, password);
                    if (data.success) login(data);
                    else setError(data.message);
                } catch (err) { setError(err.message); } 
                finally { setLoading(false); }
            };
            return (
                <>
                    <div className="min-h-screen bg-slate-100 flex flex-col justify-center items-center">
                        <div className="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800">VMS Dashboard</h1>
                                <p className="text-gray-500 mt-2">Welcome back! Please log in.</p>
                            </div>
                            {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">{error}</div>}
                            <form onSubmit={handleSubmit}>
                                <div className="mb-4">
                                    <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="username">Username (Email)</label>
                                    <input className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="username" type="email" value={username} onChange={(e) => setUsername(e.target.value)} required />
                                </div>
                                <div className="mb-6">
                                    <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">Password</label>
                                    <input className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} required />
                                </div>
                                <button className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded w-full flex justify-center items-center" type="submit" disabled={loading}>{loading ? <Spinner size="5" /> : 'Sign In'}</button>
                                <div className="text-center mt-4">
                                    <a className="inline-block align-baseline font-bold text-sm text-indigo-600 hover:text-indigo-800" href="#" onClick={(e) => {e.preventDefault(); setForgotPasswordOpen(true);}}>Forgot Password?</a>
                                </div>
                            </form>
                        </div>
                    </div>
                </>
            );
        };

        const DashboardPage = ({ sheetKey }) => {
            const { user, updatePreferences } = useAuth();
            const [rawData, setRawData] = useState({ header: [], rows: [] });
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'ascending' });
            const [generalFilter, setGeneralFilter] = useState('');
            const [statusFilter, setStatusFilter] = useState('');
            const [unsavedChanges, setUnsavedChanges] = useState({});
            const [modalState, setModalState] = useState({ type: null, job: null });
            const [isColumnModalOpen, setColumnModalOpen] = useState(false);

            const userPrefs = useMemo(() => {
                try {
                    const prefs = user?.dashboardPreferences;
                    return {
                        order: prefs?.columnOrder ? JSON.parse(prefs.columnOrder) : [],
                        visibility: prefs?.columnVisibility ? JSON.parse(prefs.columnVisibility) : []
                    };
                } catch (e) {
                    return { order: [], visibility: [] };
                }
            }, [user]);

            const loadData = useCallback(async () => {
                setLoading(true);
                setError('');
                setUnsavedChanges({});
                try {
                    const result = await api.getDashboardData(sheetKey, user.userIdentifier);
                    if (result.success) {
                        setRawData({ header: result.header, rows: result.rows });
                    } else {
                        setError(result.message);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }, [sheetKey, user.userIdentifier]);

            useEffect(() => { loadData(); }, [loadData]);
            
            const { displayHeader, displayData } = useMemo(() => {
                const { header, rows } = rawData;
                if (!header || header.length === 0) return { displayHeader: [], displayData: [] };

                let newHeader = [...header];
                let newRows = rows.map(r => [...r]);

                const clientIndex = newHeader.indexOf('Client Name');
                const postingFromIndex = newHeader.indexOf('Posting From');
                
                if (clientIndex !== -1 && postingFromIndex !== -1) {
                    newHeader[clientIndex] = 'Client Info';
                    newHeader.splice(postingFromIndex, 1);
                    newRows = newRows.map(row => {
                        const client = row[clientIndex] || '';
                        const location = row[postingFromIndex] || '';
                        let clientInfo = (client && location && location !== 'All') ? `${client} / ${location}` : (client || location);
                        const newRow = [...row];
                        newRow[clientIndex] = clientInfo;
                        newRow.splice(postingFromIndex, 1);
                        return newRow;
                    });
                }
                
                newHeader = newHeader.filter(h => h !== 'Company Name');

                if (userPrefs.order.length > 0) {
                    const orderedHeader = userPrefs.order.filter(h => newHeader.includes(h));
                    const remainingHeader = newHeader.filter(h => !userPrefs.order.includes(h));
                    const finalHeaderOrder = [...orderedHeader, ...remainingHeader];
                    
                    const reorderIndices = finalHeaderOrder.map(h => newHeader.indexOf(h));
                    newRows = newRows.map(row => reorderIndices.map(i => row[i]));
                    newHeader = finalHeaderOrder;
                }
                
                if (userPrefs.visibility.length > 0) {
                    const visibleHeader = newHeader.filter(h => !userPrefs.visibility.includes(h));
                    const visibleIndices = visibleHeader.map(h => newHeader.indexOf(h));
                    newRows = newRows.map(row => visibleIndices.map(i => row[i]));
                    newHeader = visibleHeader;
                }

                return { displayHeader: newHeader, displayData: newRows };
            }, [rawData, sheetKey, userPrefs]);

            const handleSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') direction = 'descending';
                setSortConfig({ key, direction });
            };
            
            const handleCellEdit = (rowIndex, cellIndex, value) => {
                const postingId = filteredAndSortedData[rowIndex][displayHeader.indexOf('Posting ID')];
                const headerName = displayHeader[cellIndex];
                
                setUnsavedChanges(prev => ({
                    ...prev,
                    [postingId]: { ...prev[postingId], [headerName]: value }
                }));
            };

            const handleSaveChanges = async () => {
                const updates = Object.entries(unsavedChanges).map(([postingId, changes]) => {
                    const backendChanges = {};
                    Object.entries(changes).forEach(([headerName, value]) => {
                        let backendKey = headerName.replace(/[^a-zA-Z0-9]/g, '');
                        backendKey = backendKey.charAt(0).toLowerCase() + backendKey.slice(1);
                        backendChanges[backendKey] = value;
                    });
                    return { rowKey: postingId, changes: backendChanges };
                });
                
                if (updates.length === 0) return;
                setLoading(true);
                try {
                    await api.updateJobPosting(updates, user.userIdentifier);
                    setUnsavedChanges({});
                } catch (err) {
                    setError(`Failed to save: ${err.message}`);
                } finally {
                    setLoading(false);
                    loadData();
                }
            };

            const handleAction = async (actionType, job) => {
                setLoading(true);
                const postingId = job['Posting ID'];
                try {
                    if (actionType === 'close') {
                        await api.updateJobStatus([postingId], 'Closed', user.userIdentifier);
                    } else {
                        await api.archiveOrDeleteJob([postingId], actionType, user.userIdentifier);
                    }
                    loadData();
                } catch (err) {
                    setError(`Action '${actionType}' failed: ${err.message}`);
                } finally {
                    setLoading(false);
                    setModalState({ type: null, job: null });
                }
            };
            
            const filteredAndSortedData = useMemo(() => {
                let processData = [...displayData];
                
                if (statusFilter) {
                    const statusIndex = displayHeader.indexOf('Status');
                    if (statusIndex > -1) processData = processData.filter(row => String(row[statusIndex]).toLowerCase() === statusFilter.toLowerCase());
                }

                if (generalFilter) {
                    processData = processData.filter(row =>
                        row.some(cell => String(cell).toLowerCase().includes(generalFilter.toLowerCase()))
                    );
                }

                if (sortConfig.key !== null) {
                    const sortIndex = displayHeader.indexOf(sortConfig.key);
                    processData.sort((a, b) => {
                        if (a[sortIndex] < b[sortIndex]) return sortConfig.direction === 'ascending' ? -1 : 1;
                        if (a[sortIndex] > b[sortIndex]) return sortConfig.direction === 'ascending' ? 1 : -1;
                        return 0;
                    });
                }
                return processData;
            }, [displayData, sortConfig, generalFilter, statusFilter, displayHeader]);

            const downloadCsv = () => {
                const csvRows = [];
                csvRows.push(displayHeader.join(','));
                for (const row of filteredAndSortedData) {
                    const values = row.map(v => `"${String(v).replace(/"/g, '""')}"`);
                    csvRows.push(values.join(','));
                }
                const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('hidden', '');
                a.setAttribute('href', url);
                a.setAttribute('download', `${sheetKey}_report.csv`);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const downloadPdf = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');
                doc.autoTable({
                    head: [displayHeader],
                    body: filteredAndSortedData,
                });
                doc.save(`${sheetKey}_report.pdf`);
            };
            
            const jobToObject = (row) => {
                const obj = {};
                displayHeader.forEach((h, i) => obj[h] = row[i]);
                return obj;
            };

            const handleSaveColumnSettings = async (newPrefs) => {
                setLoading(true);
                try {
                    await api.saveUserDashboardPreferences(user.userIdentifier, {
                        columnOrder: newPrefs.order,
                        columnVisibility: newPrefs.visibility
                    });
                    updatePreferences({
                        columnOrder: JSON.stringify(newPrefs.order),
                        columnVisibility: JSON.stringify(newPrefs.visibility)
                    });
                } catch(err) {
                    setError(`Failed to save column settings: ${err.message}`);
                } finally {
                    setLoading(false);
                    setColumnModalOpen(false);
                }
            };
            
            return (
                <div className="space-y-4">
                    <div className="bg-white p-4 rounded-lg shadow-sm border">
                        <h2 className="text-xl font-bold text-gray-800">{DASHBOARD_CONFIGS[sheetKey]?.companyName || 'Dashboard'}</h2>
                    </div>
                    
                    <div className="bg-white p-4 rounded-lg shadow-sm border flex items-center justify-between">
                        <div className="flex items-center space-x-2">
                            <input type="text" placeholder="Search to collect text..." value={generalFilter} onChange={e => setGeneralFilter(e.target.value)} className="shadow-sm border-gray-300 rounded-md w-64"/>
                        </div>
                        <div className="flex items-center space-x-2">
                            <button onClick={loadData} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Refresh</button>
                            <button onClick={handleSaveChanges} disabled={Object.keys(unsavedChanges).length === 0} className="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 disabled:bg-gray-400">Save Changes</button>
                            <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)} className="shadow-sm border-gray-300 rounded-md">
                                <option value="">All Statuses</option>
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                            </select>
                            <Dropdown trigger={<button className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Options</button>}>
                                <a href="#" onClick={(e) => {e.preventDefault(); setColumnModalOpen(true)}} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Column Settings</a>
                                <a href="#" onClick={downloadCsv} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Download CSV</a>
                                <a href="#" onClick={downloadPdf} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Download PDF</a>
                            </Dropdown>
                        </div>
                    </div>
                    
                    {loading && <div className="flex justify-center items-center h-64"><Spinner /></div>}
                    {error && <div className="text-red-500 bg-red-100 p-4 rounded-lg">Error: {error}</div>}
                    {!loading && !error && (
                        <div className="bg-white rounded-lg shadow overflow-x-auto">
                            <table className="w-full text-sm text-left text-gray-500 table-layout">
                                <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        {displayHeader.map(h => 
                                            <th key={h} scope="col" className="px-4 py-3" >
                                                <div onClick={() => handleSort(h)} className="sortable-header font-bold">
                                                    {h} {sortConfig.key === h ? (sortConfig.direction === 'ascending' ? '▲' : '▼') : ''}
                                                </div>
                                            </th>
                                        )}
                                        <th scope="col" className="px-4 py-3">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredAndSortedData.map((row, rowIndex) => (
                                        <tr key={row[0] || rowIndex} className="bg-white border-b hover:bg-gray-50">
                                            {row.map((cell, cellIndex) => {
                                                const headerName = displayHeader[cellIndex];
                                                const isEditable = EDITABLE_COLUMNS.includes(headerName);
                                                const isDate = DATE_COLUMNS.includes(headerName);
                                                const postingId = row[displayHeader.indexOf('Posting ID')];
                                                const isModified = unsavedChanges[postingId] && unsavedChanges[postingId][headerName] !== undefined;
                                                
                                                return (
                                                    <td key={cellIndex} 
                                                        className={`px-4 py-3 ${isModified ? 'modified-cell' : ''} ${headerName === 'Required Skill Set' ? 'wrap-text' : ''}`}
                                                        contentEditable={isEditable}
                                                        suppressContentEditableWarning={true}
                                                        onBlur={e => isEditable && handleCellEdit(rowIndex, cellIndex, e.target.innerText)}
                                                    >
                                                        {isDate ? formatDate(cell) : cell}
                                                    </td>
                                                );
                                            })}
                                            <td className="px-4 py-3">
                                                <ActionMenu job={row} onAction={(type, job) => setModalState({type, job: jobToObject(job)})} />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                    
                    <ConfirmationModal 
                        isOpen={['close', 'archive', 'delete'].includes(modalState.type)}
                        onClose={() => setModalState({type: null, job: null})}
                        onConfirm={() => handleAction(modalState.type, modalState.job)}
                        title={`Confirm ${modalState.type}`}
                        message={`Are you sure you want to ${modalState.type} the job "${modalState.job?.['Posting Title']}"?`}
                        confirmText={modalState.type}
                    />
                    <ViewDetailsModal 
                        isOpen={modalState.type === 'details'}
                        onClose={() => setModalState({type: null, job: null})}
                        job={modalState.job}
                    />
                    <ColumnSettingsModal 
                        isOpen={isColumnModalOpen}
                        onClose={() => setColumnModalOpen(false)}
                        allHeaders={rawData.header.filter(h => h !== 'Company Name' && h !== 'Posting From')}
                        userPrefs={userPrefs}
                        onSave={handleSaveColumnSettings}
                    />
                </div>
            );
        };
        
        const ColumnSettingsModal = ({ isOpen, onClose, allHeaders, userPrefs, onSave }) => {
            const [order, setOrder] = useState([]);
            const [visibility, setVisibility] = useState({});
            const dragItem = useRef();
            const dragOverItem = useRef();

            useEffect(() => {
                const initialOrder = userPrefs.order.length > 0 
                    ? userPrefs.order.filter(h => allHeaders.includes(h))
                    : allHeaders;
                const remainingHeaders = allHeaders.filter(h => !initialOrder.includes(h));
                setOrder([...initialOrder, ...remainingHeaders]);

                const initialVisibility = {};
                allHeaders.forEach(h => {
                    initialVisibility[h] = !userPrefs.visibility.includes(h);
                });
                setVisibility(initialVisibility);
            }, [isOpen, allHeaders, userPrefs]);

            const handleDragStart = (e, position) => {
                dragItem.current = position;
                e.target.classList.add('dragging');
            };

            const handleDragEnter = (e, position) => {
                dragOverItem.current = position;
            };
            
            const handleDrop = (e) => {
                const newOrder = [...order];
                const dragItemContent = newOrder[dragItem.current];
                newOrder.splice(dragItem.current, 1);
                newOrder.splice(dragOverItem.current, 0, dragItemContent);
                dragItem.current = null;
                dragOverItem.current = null;
                setOrder(newOrder);
                e.target.closest('.column-list-item').classList.remove('dragging');
            };

            const handleVisibilityChange = (header) => {
                setVisibility(prev => ({...prev, [header]: !prev[header]}));
            };

            const handleSave = () => {
                const hiddenColumns = Object.entries(visibility)
                    .filter(([_, isVisible]) => !isVisible)
                    .map(([header]) => header);
                onSave({ order, visibility: hiddenColumns });
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Column Settings" size="lg">
                    <p className="text-gray-600 mb-4">Drag and drop to reorder. Check/uncheck to show/hide.</p>
                    <div className="space-y-2">
                        {order.map((header, index) => (
                            <div key={header} 
                                className="flex items-center justify-between p-2 bg-gray-50 rounded-md border cursor-grab column-list-item"
                                draggable
                                onDragStart={(e) => handleDragStart(e, index)}
                                onDragEnter={(e) => handleDragEnter(e, index)}
                                onDragEnd={(e) => e.target.classList.remove('dragging')}
                                onDragOver={(e) => e.preventDefault()}
                                onDrop={handleDrop}
                            >
                                <span>{header}</span>
                                <input type="checkbox" checked={visibility[header] || false} onChange={() => handleVisibilityChange(header)} className="h-5 w-5 rounded"/>
                            </div>
                        ))}
                    </div>
                    <div className="flex justify-end mt-6 space-x-2">
                        <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                        <button onClick={handleSave} className="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Settings</button>
                    </div>
                </Modal>
            );
        };

        const ActionMenu = ({ job, onAction }) => (
            <Dropdown trigger={
                <button className="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                </button>
            }>
                <a href="#" onClick={(e) => {e.preventDefault(); onAction('details', job)}} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">View Details</a>
                <a href="#" onClick={(e) => {e.preventDefault(); onAction('close', job)}} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Close Job</a>
                <a href="#" onClick={(e) => {e.preventDefault(); onAction('archive', job)}} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Archive Job</a>
                <a href="#" onClick={(e) => {e.preventDefault(); onAction('delete', job)}} className="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Delete Job</a>
            </Dropdown>
        );

        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message, confirmText }) => {
            const confirmButtonClasses = {
                delete: 'bg-red-600 hover:bg-red-700',
                archive: 'bg-yellow-500 hover:bg-yellow-600',
                close: 'bg-blue-500 hover:bg-blue-600',
            };
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={title} size="sm">
                    <p className="text-gray-600">{message}</p>
                    <div className="flex justify-end mt-6 space-x-2">
                        <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                        <button onClick={onConfirm} className={`px-4 py-2 text-white rounded-md ${confirmButtonClasses[confirmText] || 'bg-indigo-600'}`}>{confirmText}</button>
                    </div>
                </Modal>
            );
        };

        const ViewDetailsModal = ({ isOpen, onClose, job }) => (
            <Modal isOpen={isOpen} onClose={onClose} title="Job Details" size="lg">
                {job && (
                    <div className="space-y-4">
                        {Object.entries(job).map(([key, value]) => (
                            <div key={key}>
                                <h4 className="text-sm font-medium text-gray-500">{key}</h4>
                                <p className="text-gray-800">{String(DATE_COLUMNS.includes(key) ? formatDate(value) : value)}</p>
                            </div>
                        ))}
                    </div>
                )}
            </Modal>
        );

        const TopNav = ({ user, logout, currentPage, setCurrentPage }) => {
            const isAdmin = user?.userRole?.includes('Admin');
            return (
                <header className="bg-white shadow-md">
                    <div className="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex justify-between items-center h-16">
                            <div className="flex items-center space-x-8">
                                <h1 className="text-2xl font-bold text-indigo-600">VMS Portal</h1>
                                <nav className="hidden md:flex space-x-4">
                                    <Dropdown trigger={<button className={`px-3 py-2 rounded-md text-sm font-medium ${currentPage.type === 'dashboard' ? 'text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>Dashboards</button>}>
                                        {Object.entries(DASHBOARD_CONFIGS).map(([key, config]) => (
                                            <a href="#" key={key} onClick={(e) => {e.preventDefault(); setCurrentPage({type: 'dashboard', key})}} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">{config.title}</a>
                                        ))}
                                    </Dropdown>
                                    <a href="#" onClick={(e) => {e.preventDefault(); setCurrentPage({type: 'reports'})}} className={`px-3 py-2 rounded-md text-sm font-medium ${currentPage.type === 'reports' ? 'text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>Reports</a>
                                    {isAdmin && <a href="#" onClick={(e) => {e.preventDefault(); setCurrentPage({type: 'admin'})}} className={`px-3 py-2 rounded-md text-sm font-medium ${currentPage.type === 'admin' ? 'text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>Admin</a>}
                                </nav>
                            </div>
                            <div className="flex items-center">
                                <Dropdown trigger={
                                    <button className="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        <span className="sr-only">Open user menu</span>
                                        <div className="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5 text-gray-600"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                        </div>
                                    </button>
                                }>
                                    <div className="px-4 py-2 border-b">
                                        <p className="text-sm font-medium text-gray-900">{user.userName}</p>
                                        <p className="text-sm text-gray-500 truncate">{user.userIdentifier}</p>
                                    </div>
                                    <a href="#" onClick={logout} className="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Logout</a>
                                </Dropdown>
                            </div>
                        </div>
                    </div>
                </header>
            );
        };

        const MainApp = () => {
            const [currentPage, setCurrentPage] = useState({type: 'dashboard', key: 'ecaltVMSDisplay'});
            const { user, logout } = useAuth();
            
            return (
                <div className="min-h-screen bg-gray-100">
                    <TopNav user={user} logout={logout} currentPage={currentPage} setCurrentPage={setCurrentPage} />
                    <main className="px-4 sm:px-6 lg:px-8 py-6">
                        {currentPage.type === 'dashboard' && <DashboardPage sheetKey={currentPage.key} />}
                        {/* {currentPage.type === 'reports' && <ReportsPage />} */}
                        {/* {currentPage.type === 'admin' && <AdminPage />} */}
                    </main>
                </div>
            );
        };
        
        const App = () => {
            const { isAuthenticated, isFirstLogin } = useAuth();
            if (!isAuthenticated) return <LoginPage />;
            // if (isFirstLogin) return <ChangePasswordPage />;
            return <MainApp />;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<AuthProvider><App /></AuthProvider>);

    </script>
</body>
</html>
